<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; line-height: 1.5; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        .upload-zone { background: white; border: 2px dashed #cbd5e1; padding: 40px; text-align: center; border-radius: 12px; cursor: pointer; transition: 0.3s; margin-bottom: 20px;}
        .upload-zone:hover { border-color: var(--primary); background: #eff6ff; }
        #status { margin-top: 15px; font-weight: bold; color: var(--primary); }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 30px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        th, td { padding: 12px 15px; text-align: right; border-bottom: 1px solid #e2e8f0; }
        th { background: #f1f5f9; font-weight: 600; text-align: center; }
        td:first-child, td:nth-child(2), td:nth-child(3) { text-align: center; }
        .row-domestic { background-color: #f0fdf4; font-weight: bold; }
        .row-overseas { background-color: #fef2f2; font-weight: bold; }
        .row-total { background-color: #eff6ff; font-weight: bold; font-size: 1.1em; }
        .hidden { display: none; }
        .console { background: #0f172a; color: #10b981; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 150px; overflow-y: auto; margin-top: 10px; }
        .debug-log { background: #1e293b; color: #f8fafc; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ OCR ë¶„ì„ê¸°</h1>
        <p>ì£¼ì‹ ê³„ì¢Œ ìº¡ì²˜ í™”ë©´ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ìƒí’ˆì„ ë¶„ë¥˜í•˜ê³  ë¹„ì¤‘ì„ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
    </header>

    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
        <span>ì´ê³³ì„ í´ë¦­í•˜ì—¬ ê³„ì¢Œ ìº¡ì²˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš” (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)</span>
        <input type="file" id="fileInput" class="hidden" multiple accept="image/*">
        <div id="status">ëŒ€ê¸° ì¤‘...</div>
    </div>

    <div id="uiConsole">
        <h3 style="color: #64748b;">ğŸ–¥ï¸ ì‹œìŠ¤í…œ ì½˜ì†” ë° OCR ì¶”ì¶œ ê²°ê³¼</h3>
        <div id="consoleLog" class="console">> ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ...</div>
        <div id="rawLog" class="debug-log hidden"></div>
    </div>

    <table id="resultTable" class="hidden">
        <thead>
            <tr>
                <th>ìƒí’ˆëª…</th>
                <th>êµ­ê°€ êµ¬ë¶„</th>
                <th>ë¶„ë¥˜</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>í˜„ì¬ê°€</th>
                <th>í‰ê°€ê¸ˆ</th>
                <th>ë¹„ì¤‘</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot id="tableFoot"></tfoot>
    </table>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const status = document.getElementById('status');
    const consoleLog = document.getElementById('consoleLog');
    const rawLog = document.getElementById('rawLog');
    const resultTable = document.getElementById('resultTable');
    const tableBody = document.getElementById('tableBody');
    const tableFoot = document.getElementById('tableFoot');

    const CONFIG = {
        overseasKeywords: ['ë¯¸êµ­', 'ì¼ë³¸', 'S&P500', 'NASDAQ', 'VANGUARD', 'AGNC', 'ì• í”Œ', 'CHANA', 'ë² íŠ¸ë‚¨'],
        assetTypes: [
            { key: 'ë¦¬ì¸ ', val: 'ë¶€ë™ì‚°(ë¦¬ì¸ )' },
            { key: 'ì±„ê¶Œ', val: 'ì±„ê¶Œí˜•' },
            { key: 'ê¸ˆí˜„ë¬¼', val: 'ì›ìì¬' },
            { key: 'ì•¡í‹°ë¸Œ', val: 'ì•¡í‹°ë¸ŒETF' }
        ],
        excludeLines: ['ê´€ì‹¬ê·¸ë£¹', 'ì¢…ëª©ì¶”ê°€', 'ë‰´ìŠ¤', 'ê³µì‹œ', 'í† ë¡ ', 'ì§€ì—°', 'ì£¼ë¬¸']
    };

    function logToUI(msg) {
        const time = new Date().toLocaleTimeString();
        consoleLog.innerHTML += `<div><span style="color: #94a3b8;">[${time}]</span> ${msg}</div>`;
        consoleLog.scrollTop = consoleLog.scrollHeight;
    }

    fileInput.addEventListener('change', async (e) => {
        const files = e.target.files;
        if (files.length === 0) return;

        logToUI(`${files.length}ê°œì˜ íŒŒì¼ ë¶„ì„ ì‹œì‘...`);
        rawLog.classList.remove('hidden');
        let combinedResults = [];

        for (const file of files) {
            try {
                const result = await Tesseract.recognize(file, 'kor+eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            status.innerText = `ë¶„ì„ ì¤‘... (${(m.progress * 100).toFixed(0)}%)`;
                        }
                    }
                });

                const text = result.data.text;
                rawLog.innerText += `\n--- [${file.name} ì¶”ì¶œ ê²°ê³¼] ---\n${text}\n`;
                
                const parsedData = parseOCRText(text);
                combinedResults = [...combinedResults, ...parsedData];
            } catch (err) {
                logToUI(`<span style="color: #ef4444;">âŒ OCR ì—ëŸ¬: ${err.message}</span>`);
            }
        }

        if (combinedResults.length > 0) {
            renderEditableTable(combinedResults);
            status.innerText = "ë¶„ì„ ì™„ë£Œ!";
            resultTable.classList.remove('hidden');
        } else {
            status.innerText = "ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
            logToUI("âš ï¸ ìœ íš¨í•œ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    });

    function parseOCRText(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 1);
        const results = [];

        for (let i = 0; i < lines.length; i++) {
            let line = lines[i];
            if (CONFIG.excludeLines.some(k => line.includes(k))) continue;

            // ì¢…ëª©ëª… íŒë³„: í•œê¸€/ì˜ë¬¸ ë¹„ì¤‘ì´ ë†’ê³  ìˆ«ìê°€ ì ì€ ì¤„
            const numCount = (line.match(/\d/g) || []).length;
            if (numCount / line.length < 0.4) {
                let name = line.replace(/[_-]/g, '').trim();
                let qty = 0, price = 0;

                // ë‹¤ìŒ 4ì¤„ê¹Œì§€ ìˆ˜ëŸ‰(ì£¼)ê³¼ ê°€ê²©(í˜„ì¬ê°€) íƒìƒ‰
                for (let j = 1; j <= 4; j++) {
                    if (i + j >= lines.length) break;
                    const nextLine = lines[i + j].replace(/,/g, '');
                    const numbers = nextLine.match(/\d+(\.\d+)?/g);

                    if (numbers) {
                        numbers.forEach(num => {
                            const val = parseFloat(num);
                            // ìˆ˜ëŸ‰ í›„ë³´ (í†µìƒ ìˆ˜ë°±~ìˆ˜ë§Œ ë‹¨ìœ„)
                            if (val > 0 && val < 50000 && qty === 0) qty = val;
                            // ê°€ê²© í›„ë³´ (í˜„ì¬ê°€)
                            else if (val > 10 && price === 0) price = val;
                        });
                    }
                }

                if (qty > 0 || price > 0) {
                    let country = CONFIG.overseasKeywords.some(k => name.toUpperCase().includes(k)) ? "í•´ì™¸" : "êµ­ë‚´";
                    let type = "ì£¼ì‹í˜•";
                    for (const rule of CONFIG.assetTypes) {
                        if (name.includes(rule.key)) { type = rule.val; break; }
                    }
                    results.push({ name, country, type, qty: Math.floor(qty), price });
                    logToUI(`ë§¤ì¹­ ì„±ê³µ: ${name} (${qty}ì£¼, ${price}ì›)`);
                }
            }
        }
        return results;
    }

    function renderEditableTable(data) {
        tableBody.innerHTML = "";
        data.forEach(item => {
            const evaluation = item.qty * item.price;
            tableBody.innerHTML += `
                <tr>
                    <td contenteditable="true" oninput="updateAllTotals()">${item.name}</td>
                    <td contenteditable="true" oninput="updateAllTotals()">${item.country}</td>
                    <td contenteditable="true" oninput="updateAllTotals()">${item.type}</td>
                    <td contenteditable="true" oninput="updateAllTotals()">${item.qty.toLocaleString()}</td>
                    <td contenteditable="true" oninput="updateAllTotals()">${item.price.toLocaleString()}</td>
                    <td class="eval-cell">${evaluation.toLocaleString()}</td>
                    <td class="weight-cell">0%</td>
                </tr>`;
        });
        updateAllTotals();
    }

    function updateAllTotals() {
        let domSum = 0, osSum = 0;
        const rows = document.querySelectorAll("#tableBody tr");

        rows.forEach(row => {
            const country = row.cells[1].innerText.trim();
            const qty = parseFloat(row.cells[3].innerText.replace(/,/g, '')) || 0;
            const price = parseFloat(row.cells[4].innerText.replace(/,/g, '')) || 0;
            const eval = qty * price;
            row.cells[5].innerText = eval.toLocaleString();
            if (country === "í•´ì™¸") osSum += eval; else domSum += eval;
        });

        const total = domSum + osSum;
        rows.forEach(row => {
            const eval = parseFloat(row.cells[5].innerText.replace(/,/g, '')) || 0;
            row.cells[6].innerText = total > 0 ? ((eval / total) * 100).toFixed(1) + "%" : "0%";
        });

        tableFoot.innerHTML = `
            <tr class="row-domestic"><td colspan="5">êµ­ë‚´ í•©ê³„</td><td>${domSum.toLocaleString()}</td><td>${total > 0 ? ((domSum/total)*100).toFixed(1) : 0}%</td></tr>
            <tr class="row-overseas"><td colspan="5">í•´ì™¸ í•©ê³„</td><td>${osSum.toLocaleString()}</td><td>${total > 0 ? ((osSum/total)*100).toFixed(1) : 0}%</td></tr>
            <tr class="row-total"><td colspan="5">ì „ì²´ í•©ê³„</td><td>${total.toLocaleString()}</td><td>100%</td></tr>
        `;
    }
    
    // ì‹œìŠ¤í…œ ì½˜ì†” ì¶œë ¥ í•¨ìˆ˜
    function logToUI(msg) {
        const consoleLog = document.getElementById('consoleLog');
        const time = new Date().toLocaleTimeString();
        consoleLog.innerHTML += `<div><span style="color: #94a3b8;">[${time}]</span> ${msg}</div>`;
        consoleLog.scrollTop = consoleLog.scrollHeight;
    }
</script>

</body>
</html>
